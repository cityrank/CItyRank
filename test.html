<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CityRank Web</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
    <style>
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Initialize CloudKit
        CloudKit.configure({
            containers: [{
                containerIdentifier: 'iCloud.com.mikita.mapapp',
                apiTokenAuth: { apiToken: 'dd4d64c3658e17b6e76e0b2ab9747b521402cce76910c29e89d6c6d3615a6cbf', persist: true },
                environment: 'development' // or 'production' depending on your setup
            }]
        });

        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoibWlraXRrbzEiLCJhIjoiY20wemJxaDVzMDVheDJqczg0NnV3MG1jbyJ9.8MNS07csgIJkUXTGjZiaYA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [0, 0],
            zoom: 2
        });

        // Fetch data from CloudKit
        CloudKit.getDefaultContainer().publicCloudDatabase.performQuery({
            recordType: 'CityComment',
            filterBy: [{
                fieldName: 'rating',
                comparator: 'NOT_EQUAL',
                fieldValue: { value: null }
            }]
        }).then(response => {
            if (response.hasErrors) {
                console.error(response.errors);
                return;
            }
            const records = response.records;
            records.forEach(record => {
                const cityName = record.fields.cityName.value;
                const rating = record.fields.rating.value;
                const longitude = record.fields.longitude ? record.fields.longitude.value : 0;
                const latitude = record.fields.latitude ? record.fields.latitude.value : 0;

                // Add marker for each city with rating
                new mapboxgl.Marker()
                    .setLngLat([longitude, latitude])
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setText(`${cityName}: Rating ${rating}`))
                    .addTo(map);
            });
        }).catch(error => {
            console.error('CloudKit query failed:', error);
        });
    </script>
</body>
</html>
