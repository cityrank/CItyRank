<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CityRank Web</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
    <style>
        #map { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Initialize CloudKit
        CloudKit.configure({
            containers: [{
                containerIdentifier: 'iCloud.com.mikita.mapapp',
                apiTokenAuth: { apiToken: '598d528768fec35ae10417d3313fd4ae6fc6c65907a2e2e7bf88491f0eff9d0a', persist: true },
                environment: 'production'
            }]
        });

        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoibWlraXRrbzEiLCJhIjoiY20wemJxaDVzMDVheDJqczg0NnV3MG1jbyJ9.8MNS07csgIJkUXTGjZiaYA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [0, 0],
            zoom: 2,
            projection: 'globe' // Set the map projection to a globe
        });

        // Set atmosphere and customize view appearance
        map.on('style.load', () => {
            map.setFog({
                color: 'rgba(135, 206, 235, 0.5)', // Light sky blue near horizon
                "high-color": 'rgba(70, 130, 180, 0.8)', // Soft blue higher in the atmosphere
                "space-color": 'rgba(20, 24, 82, 1.0)', // Deep navy for space
                "horizon-blend": 0.1,
                "star-intensity": 0.1
            });
            map.setMinZoom(1.0);
            map.setMaxZoom(11.0);
        });

        // Hide scale, compass, and other non-essential ornaments
        map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'bottom-right');

        // Colors based on rating
        const ratingColors = {
            5: '#2ecc71',   // Green
            4: '#27ae60',   // Light green
            3: '#f1c40f',   // Yellow
            2: '#e67e22',   // Orange
            1: '#e74c3c'    // Red
        };

        // Fetch data from CloudKit and plot on the map
        CloudKit.getDefaultContainer().publicCloudDatabase.performQuery({
            recordType: 'CityComment'
        }).then(response => {
            if (response.hasErrors) {
                console.error('CloudKit query failed:', response.errors);
                return;
            }

            const records = response.records;
            records.forEach(record => {
                const cityName = record.fields.cityName ? record.fields.cityName.value : "Unknown City";
                const comment = record.fields.comment ? record.fields.comment.value : "No comment";
                const rating = record.fields.rating ? record.fields.rating.value : 0;

                // Geocode each city to find its coordinates
                geocodeCity(cityName).then(coordinate => {
                    if (coordinate) {
                        addCityCircle(coordinate, { cityName, rating, comment });
                    }
                });
            });
        }).catch(error => {
            console.error('CloudKit query failed:', error);
        });

        // Geocode city name to coordinates
        function geocodeCity(cityName) {
            return fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(cityName)}.json?access_token=${mapboxgl.accessToken}`)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        return data.features[0].geometry.coordinates;
                    }
                    console.error("Failed to geocode:", cityName);
                    return null;
                });
        }

        // Add a circle to the map for each city
        function addCityCircle(coordinate, city) {
            const color = ratingColors[Math.round(city.rating)] || '#3498db'; // Default color if no rating

            // Create a GeoJSON source and add it as a layer
            map.addLayer({
                id: `${city.cityName}-circle`,
                type: 'circle',
                source: {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: [{
                            type: 'Feature',
                            geometry: { type: 'Point', coordinates: coordinate },
                            properties: {
                                cityName: city.cityName,
                                rating: city.rating,
                                comment: city.comment
                            }
                        }]
                    }
                },
                paint: {
                    'circle-radius': 10,
                    'circle-color': color,
                    'circle-opacity': 0.7
                }
            });

            // Add a click event for each city circle
            map.on('click', `${city.cityName}-circle`, (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: [`${city.cityName}-circle`] });
                if (features.length) {
                    const cityName = features[0].properties.cityName;
                    const rating = features[0].properties.rating;
                    const comment = features[0].properties.comment;

                    // Display city details in a popup
                    new mapboxgl.Popup()
                        .setLngLat(coordinate)
                        .setHTML(`
                            <strong>City:</strong> ${cityName}<br>
                            <strong>Rating:</strong> ${rating}<br>
                            <strong>Comment:</strong> ${comment || 'No comment'}
                        `)
                        .addTo(map);
                }
            });
        }
    </script>
</body>
</html>
