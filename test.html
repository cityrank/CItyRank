<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CityRank Web</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.7.0/mapbox-gl.js"></script>
    <script src="https://cdn.apple-cloudkit.com/ck/2/cloudkit.js"></script>
<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden; /* Prevents scrollbars */
    }
    #map {
        width: 100%;
        height: 100vh;
    }
</style>

</head>
<body>
    <div id="map"></div>
    <script>
        // Initialize CloudKit
        CloudKit.configure({
            containers: [{
                containerIdentifier: 'iCloud.com.mikita.mapapp',
                apiTokenAuth: { apiToken: '598d528768fec35ae10417d3313fd4ae6fc6c65907a2e2e7bf88491f0eff9d0a', persist: true },
                environment: 'production'
            }]
        });

        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoibWlraXRrbzEiLCJhIjoiY20wemJxaDVzMDVheDJqczg0NnV3MG1jbyJ9.8MNS07csgIJkUXTGjZiaYA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [0, 0],
            zoom: 2,
            projection: 'globe' // Set the map projection to a globe
        });

        // Apply globe settings, atmosphere, and adjust appearance of layers
        map.on('style.load', () => {
            // Set atmosphere for globe projection
            map.setFog({
                color: 'rgba(135, 206, 235, 0.5)', // Light sky blue near horizon
                "high-color": 'rgba(70, 130, 180, 0.8)', // Soft blue higher in the atmosphere
                "space-color": 'rgba(20, 24, 82, 1.0)', // Deep navy for space
                "horizon-blend": 0.1,
                "star-intensity": 0.1
            });

            // Set minimum and maximum zoom limits
            map.setMinZoom(1.0);
            map.setMaxZoom(11.0);

            // Hide non-essential layers
            const layersToHide = [
               "national-park", "landuse", "pitch-outline",
               "aeroway-polygon", "aeroway-line",
               "building-outline", "building",
               "tunnel-street-minor-low", "tunnel-street-minor-case",
               "tunnel-primary-secondary-tertiary-case", "tunnel-major-link-case",
               "tunnel-motorway-trunk-case", "tunnel-construction",
               "tunnel-path", "tunnel-steps",
               "tunnel-major-link", "tunnel-pedestrian",
               "tunnel-street-minor", "tunnel-primary-secondary-tertiary",
               "tunnel-oneway-arrow-blue", "tunnel-motorway-trunk",
               "tunnel-oneway-arrow-white",
               "ferry", "ferry-auto",
               "road-path-bg", "road-steps-bg",
               "turning-feature-outline", "road-pedestrian-case",
               "road-minor-low", "road-street-low",
               "road-minor-case", "road-street-case",
               "road-secondary-tertiary-case", "road-primary-case",
               "road-major-link-case", "road-motorway-trunk-case",
               "road-construction", "road-path",
               "road-steps", "road-major-link",
               "road-pedestrian", "road-pedestrian-polygon-fill",
               "road-pedestrian-polygon-pattern", "road-polygon",
               "road-minor", "road-street",
               "road-secondary-tertiary", "road-primary",
               "road-oneway-arrow-blue", "road-motorway-trunk",
               "road-rail", "road-rail-tracks",
               "level-crossing", "road-oneway-arrow-white",
               "turning-feature", "golf-hole-line",
               "bridge-path-bg", "bridge-steps-bg",
               "bridge-pedestrian-case", "bridge-street-minor-low",
               "bridge-street-minor-case", "bridge-primary-secondary-tertiary-case",
               "bridge-major-link-case", "bridge-motorway-trunk-case",
               "bridge-construction", "bridge-path",
               "bridge-steps", "bridge-major-link",
               "bridge-pedestrian", "bridge-street-minor",
               "bridge-primary-secondary-tertiary", "bridge-oneway-arrow-blue",
               "bridge-motorway-trunk", "bridge-rail",
               "bridge-rail-tracks", "bridge-major-link-2-case",
               "bridge-motorway-trunk-2-case", "bridge-major-link-2",
               "bridge-motorway-trunk-2", "bridge-oneway-arrow-white",
               "aerialway",
               "building-number-label", "road-label",
               "road-number-shield", "road-exit-shield",
               "golf-hole-label",
               "natural-line-label", "natural-point-label",
               "poi-label", "transit-label",
               "airport-label", "settlement-subdivision-label",
               "state-label", "water-line-label", "water-point-label", "waterway-label", "admin-1-boundary", "admin-1-boundary-bg"
            ];

            layersToHide.forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.setLayoutProperty(layerId, 'visibility', 'none');
                }
            });

            // Apply default colors for remaining layers
            map.getStyle().layers.forEach(layer => {
                if (layer.type === 'fill' || layer.type === 'line') {
                    map.setPaintProperty(layer.id, 'fill-color', '#d3d3d3');
                    map.setPaintProperty(layer.id, 'line-color', '#A9A9A9');
                }
            });
        });

        // Colors based on rating
        const ratingColors = {
            5: '#2ecc71',   // Green
            4: '#27ae60',   // Light green
            3: '#f1c40f',   // Yellow
            2: '#e67e22',   // Orange
            1: '#e74c3c'    // Red
        };

        // Fetch data from CloudKit and plot on the map
        CloudKit.getDefaultContainer().publicCloudDatabase.performQuery({
            recordType: 'CityComment'
        }).then(response => {
            if (response.hasErrors) {
                console.error('CloudKit query failed:', response.errors);
                return;
            }

            const records = response.records;
            records.forEach(record => {
                const cityName = record.fields.cityName ? record.fields.cityName.value : "Unknown City";
                const comment = record.fields.comment ? record.fields.comment.value : "No comment";
                const rating = record.fields.rating ? record.fields.rating.value : 0;

                // Geocode each city to find its coordinates
                geocodeCity(cityName).then(coordinate => {
                    if (coordinate) {
                        addCityCircle(coordinate, { cityName, rating, comment });
                    }
                });
            });
        }).catch(error => {
            console.error('CloudKit query failed:', error);
        });

        // Geocode city name to coordinates
        function geocodeCity(cityName) {
            return fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(cityName)}.json?access_token=${mapboxgl.accessToken}`)
                .then(response => response.json())
                .then(data => {
                    if (data.features && data.features.length > 0) {
                        return data.features[0].geometry.coordinates;
                    }
                    console.error("Failed to geocode:", cityName);
                    return null;
                });
        }

        // Add a circle to the map for each city
        function addCityCircle(coordinate, city) {
            const color = ratingColors[Math.round(city.rating)] || '#3498db'; // Default color if no rating

            // Create a GeoJSON source and add it as a layer
            map.addLayer({
                id: `${city.cityName}-circle`,
                type: 'circle',
                source: {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: [{
                            type: 'Feature',
                            geometry: { type: 'Point', coordinates: coordinate },
                            properties: {
                                cityName: city.cityName,
                                rating: city.rating,
                                comment: city.comment
                            }
                        }]
                    }
                },
                paint: {
                    'circle-radius': 20,
                    'circle-color': color,
                    'circle-opacity': 0.7
                }
            });

            // Add a click event for each city circle
            map.on('click', `${city.cityName}-circle`, (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: [`${city.cityName}-circle`] });
                if (features.length) {
                    const cityName = features[0].properties.cityName;
                    const rating = features[0].properties.rating;
                    const comment = features[0].properties.comment;

                    // Display city details in a popup
                    new mapboxgl.Popup()
                        .setLngLat(coordinate)
                        .setHTML(`
                            <strong>City:</strong> ${cityName}<br>
                            <strong>Rating:</strong> ${rating}<br>
                            <strong>Comment:</strong> ${comment || 'No comment'}
                        `)
                        .addTo(map);
                }
            });
        }
    </script>
</body>
</html>
